{% extends "base.html" %}
{% block title %}{{ blog.title }}{% endblock %}

{% block content %}
<div class="container blog-detail">

    <!-- Location Info Card -->
    <div class="location-card" style="display:flex; gap:20px; margin-bottom:40px; border:1px solid #e0e0e0; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08);">
        <div class="location-left" style="flex:1;">
            <h2>{{ blog.title }}</h2>
            <p>By {{ blog.author }} | {{ blog.date }}</p>
            <p>{{ blog.story }}</p>
        </div>
        <div class="location-right" style="flex:1; display:flex; flex-wrap:wrap; gap:10px;">
            {% for img in blog.images %}
                <div class="image-box">
                    <img src="{{ img }}" alt="{{ blog.title }}" >
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Map Section -->
    <div class="map-section" style="margin-bottom:30px;">
        <h3>Location Map</h3>
        <div id="map" style="height:500px; width:100%; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08);"></div>
    </div>

    <!-- Accommodations Section -->
    <div class="accommodation-section" style="margin-bottom:30px;">
        <h3>Nearby Accommodations</h3>
        <div id="accommodations" class="accommodations-carousel" style="display:flex; overflow-x:auto; gap:15px; padding-bottom:10px;">
            <!-- JS will populate cards here -->
        </div>
    </div>

    <div class="smart-recommendations">
        <h3>Smart Recommendations</h3>
        <p>Best suggestions for budget travelers near <strong>{{ blog.title }}</strong>:</p>
        <div id="budget-accommodations" class="accommodations-carousel">
            <p>Loading AI recommendations...</p>
        </div>
</div>

</div>

<script>
let blogLocation = {% if blog.location %}{{ blog.location | tojson | safe }}{% else %}{ lat: -37.8720, lng: 175.6820 }{% endif %};

// Haversine formula to calculate distance in km
function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the earth in km
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
    ; 
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return R * c;
}

function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
        center: blogLocation,
        zoom: 15,
    });

    const infoWindow = new google.maps.InfoWindow();

    new google.maps.marker.AdvancedMarkerElement({
        map,
        position: blogLocation,
        title: "{{ blog.title }}"
    });

    const service = new google.maps.places.PlacesService(map);
    service.nearbySearch({
        location: blogLocation,
        radius: 2000,
        type: "lodging"
    }, (results, status) => {
        const accommodationsDiv = document.getElementById('accommodations');
        const budgetDiv = document.getElementById('budget-accommodations');
        accommodationsDiv.innerHTML = '';
        budgetDiv.innerHTML = '';

        if (status === google.maps.places.PlacesServiceStatus.OK) {
            // Smart recommendations: rating >= 4 & price_level <= 2
            const smartBudget = results
                .filter(p => (p.rating >= 4 || !p.rating) && (p.price_level <= 2 || !p.price_level))
                .map(p => {
                    // Calculate distance
                    const dist = getDistanceFromLatLonInKm(blogLocation.lat, blogLocation.lng, p.geometry.location.lat(), p.geometry.location.lng());
                    p.distanceKm = dist.toFixed(1); // one decimal
                    return p;
                })
                .sort((a,b) => a.distanceKm - b.distanceKm) // nearest first
                .slice(0, 5); // top 5

            results.forEach((place) => {
                let photoUrl = '';
                if (place.photos && place.photos.length > 0) {
                    photoUrl = place.photos[0].getUrl({ maxWidth: 400 });
                }

                // Accommodation card
                const card = document.createElement('div');
                card.className = 'accommodation-card';
                card.style.cssText = `min-width:250px; flex:0 0 auto; border:1px solid #e0e0e0; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:15px; cursor:pointer;`;
                card.innerHTML = `
                    <h4 style="color:#2e7d32;">${place.name}</h4>
                    ${photoUrl ? `<img src="${photoUrl}" alt="${place.name}" style="width:100%; height:150px; object-fit:cover; border-radius:8px;">` : ''}
                    <p>${place.vicinity || ''}</p>
                    ${place.rating ? `<p>‚≠ê ${place.rating} / 5</p>` : ''}
                `;
                accommodationsDiv.appendChild(card);

                const marker = new google.maps.marker.AdvancedMarkerElement({
                    map,
                    position: place.geometry.location,
                    title: place.name
                });

                marker.addListener("click", () => {
                    infoWindow.setContent(`
                        <div style="max-width:200px;">
                            <h4>${place.name}</h4>
                            ${photoUrl ? `<img src="${photoUrl}" style="width:100%; height:120px; object-fit:cover; margin:6px 0;">` : ''}
                            <p>${place.vicinity || ''}</p>
                            ${place.rating ? `<p>‚≠ê ${place.rating} / 5</p>` : ''}
                        </div>
                    `);
                    infoWindow.open(map, marker);
                });

                card.addEventListener("click", () => {
                    map.setCenter(place.geometry.location);
                    map.setZoom(16);
                    infoWindow.setContent(`
                        <div style="max-width:200px;">
                            <h4>${place.name}</h4>
                            ${photoUrl ? `<img src="${photoUrl}" style="width:100%; height:120px; object-fit:cover; margin:6px 0;">` : ''}
                            <p>${place.vicinity || ''}</p>
                            ${place.rating ? `<p>‚≠ê ${place.rating} / 5</p>` : ''}
                        </div>
                    `);
                    infoWindow.open(map, marker);
                });
            });

            // Populate Smart Recommendations carousel
            smartBudget.forEach((place) => {
                let photoUrl = '';
                if (place.photos && place.photos.length > 0) {
                    photoUrl = place.photos[0].getUrl({ maxWidth: 400 });
                }
                const card = document.createElement('div');
                card.className = 'accommodation-card';
                card.style.cssText = `min-width:220px; flex:0 0 auto; border:1px solid #e0e0e0; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); padding:12px; cursor:pointer;`;
                card.innerHTML = `
                    <h4 style="color:#2e7d32;">${place.name}</h4>
                    ${photoUrl ? `<img src="${photoUrl}" alt="${place.name}" style="width:100%; height:120px; object-fit:cover; border-radius:6px;">` : ''}
                    <p>${place.vicinity || ''}</p>
                    ${place.rating ? `<p>‚≠ê ${place.rating} / 5</p>` : ''}
                    <p>üìç ${place.distanceKm} km from main location</p>
                `;
                budgetDiv.appendChild(card);
            });

        } else {
            accommodationsDiv.innerHTML = "<p>No nearby accommodations found.</p>";
            budgetDiv.innerHTML = "<p>No smart recommendations available.</p>";
        }
    });
}

</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap&libraries=places,marker" async defer></script>


<script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap&libraries=places,marker" async defer></script>
{% endblock %}
